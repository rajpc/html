<apex:page applyHtmlTag="false"
           applyBodyTag="false"
           showHeader="false"
           sidebar="false"
           standardStylesheets="false"
           standardController="Account"
           docType="html-5.0"
           extensions="CompanyDescriptionController">
           <apex:slds />
    <apex:form >
    <html>
        <head>
            <style type="text/css">
                body {
                font-family: "Arial Unicode MS", Arial, sans-serif;
                margin: 0;
                padding: 10px;
                font-size: 8pt;
                color: #000000;
                background-color: #ffffff;
                }
                .header-container {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
                padding-bottom: 10px;
                border-bottom: 2px solid #001f4d;
                }
                .header-title {
                font-size: 14pt;
                color: #001f4d;
                font-weight: bold;
                }
                .header-draft {
                color: #c8102e;
                font-weight: bold;
                margin-left: 5px;
                }
                .header-logo {
                position: absolute;
                right: 0;
                top: 0;
                height: 30px;
                }
                
                /* Read-only styling */
                .read-only-notice {
                background-color: #fff3cd;
                border: 1px solid #ffeaa7;
                color: #856404;
                padding: 12px;
                margin: 10px 0;
                border-radius: 4px;
                font-weight: bold;
                text-align: center;
                }
                input[readonly] {
                background-color: #f8f9fa !important;
                color: #6c757d !important;
                cursor: not-allowed;
                }
                
                .footer {
                display: flex;
                justify-content: flex-start;
                align-items: center;
                margin-top: 20px;
                padding: 0px 0;
                }
                .footer-logo {
                width: 100px;
                height: auto;
                }
                table.two-column-table {
                width: 100%;
                table-layout: fixed;
                }
                td.column {
                vertical-align: top;
                padding-right: 10px;
                width: 50%;
                }
                .section-header {
                background-color: #f2f2f2;
                padding: 6px;
                border-left: 3px solid #c8102e;
                margin: 8px 0 10px 0;
                }
                .section-header h2 {
                margin: 0;
                color: #001f4d;
                font-size: 10pt;
                }
                .company-desc .row {
                margin: 10px 0;
                position: relative;
                }
                .label-arrow {
                display: inline-block;
                background-color: #001f4d;
                color: white !important;
                font-weight: bold;
                padding: 8px 10px 4px 8px;
                margin-right: 15px;
                position: relative;
                font-size: 8pt;
                line-height: 1.2;
                }
                .label-arrow:after {
                content: "";
                position: absolute;
                right: -10px;
                top: 0;
                width: 0;
                height: 0;
                border-top: 12px solid transparent;
                border-bottom: 12px solid transparent;
                border-left: 10px solid #001f4d;
                }
                .value {
                <!-- display: inline-block; -->
                display: contents;
                color: #001f4d;
                font-size: 8pt;
                margin-left: 6px;
                vertical-align: middle;
                }
                .industry-value {
                <!-- margin-left: 30px; -->
                }
                .bullet {
                margin: 10px 0 0 20px;
                color: #001f4d;
                font-size: 8pt;
                }
                .team-table {
                width: 100%;
                margin: 10px 0;
                }
                .team-row {
                display: table-row;
                }
                .team-cell {
                display: table-cell;
                width: 50%;
                padding: 4px 8px;
                }
                .role-label {
                display: inline-block;
                background-color: #001f4d;
                color: white !important;
                font-weight: bold;
                padding: 8px 10px 4px 8px;
                margin-right: 8px;
                position: relative;
                font-size: 8pt;
                line-height: 1.2;
                }
                .role-label:after {
                content: "";
                position: absolute;
                right: -10px;
                top: 0;
                width: 0;
                height: 0;
                border-top: 12px solid transparent;
                border-bottom: 12px solid transparent;
                border-left: 10px solid #001f4d;
                }
                .role-name {
                display: inline-block;
                color: #000000;
                font-size: 7.5pt;
                margin-left: 20px;
                vertical-align: middle;
                }
                .team-cell.right-align {
                padding-left: 30px;
                }
                @page {
                size: A4;
                margin: 8mm;
                }
                .table-container {
                padding: 0.5rem;
                background-color: white;
                }
                .styled-table {
                width: 100%;
                border-collapse: collapse;
                background-color: white;
                }
                .styled-table th,
                .styled-table td {
                border: 1px solid #001f4d;
                padding: 6px 8px;
                text-align: left;
                vertical-align: top;
                font-size: 7pt;
                }
                .first-col {
                background-color: #001f4d !important;
                color: white !important;
                font-weight: bold !important;
                }
                .opp-table,
                .opportunities-table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 15px;
                }
                .opp-table th,
                .opportunities-table th {
                background-color: #001f4d;
                color: white;
                font-weight: bold;
                padding: 8px;
                border: 1px solid #001f4d;
                font-size: 7pt;
                }
                .opp-table td,
                .opportunities-table td {
                padding: 8px;
                border: 1px solid #001f4d;
                font-size: 7pt;
                }
                .category-label {
                background-color: #001f4d;
                color: white;
                font-weight: bold;
                padding: 6px 10px;
                font-size: 7pt;
                clip-path: polygon(0 0, 85% 0, 100% 50%, 85% 100%, 0% 100%);
                margin-right: 8px;
                }
                .section-content {
                padding: 0.5rem;
                width: 100%;
                }
                .open-label {
                writing-mode: vertical-rl;
                transform: rotate(180deg);
                font-weight: bold;
                font-size: 10pt;
                margin-right: 6px;
                padding-top: 0.5rem;
                }
                .row-label {
                font-weight: bold;
                background-color: white;
                text-align: left;
                font-size: 7pt;
                }
                .container, .potentialcontainer {
                display: flex;
                align-items: flex-start;
                width: 100%;
                margin-bottom: 0.5rem;
                }
                .opportunities-header {
                margin-top: 20px;
                }
                <!-- RC CSS -->
                .rc-account-table {
                    width: 100%;
                    border-collapse: collapse;
                    background-color: white;
                    margin-top: 10px;
                }
                
                .rc-account-table td {
                    border: 1px solid #001f4d;
                    padding: 6px 8px;
                    text-align: left;
                    vertical-align: top;
                    font-size: 11px;
                    width: 25%;
                }
                
                /* Center alignment and white background for column 2 */
                .rc-account-table td:nth-child(2) {
                    text-align: center;
                    background-color: white;
                    color: #000000;
                }
                
                /* Left alignment and white background for column 4 */
                .rc-account-table td:nth-child(4) {
                    text-align: left;
                    background-color: white;
                    color: #000000;
                }
                
                /* Styling for dark rows */
                .rc-dark-row {
                    background-color: #001f4d;
                    color: white;
                    font-weight: bold;
                }
            </style>
        </head>
        <body>
            <!-- Read-only notice -->
            <apex:outputPanel rendered="{!isFormReadOnly}">
                <div class="read-only-notice">
                    This form is currently read-only. Account Planning Period is not active for today's date.
                </div>
            </apex:outputPanel>
            
            <!-- Header with title and top-right logo -->
            <div class="header-container">
                <div class="header-title">
                    {!RM.Name} <span class="header-draft">|&nbsp;{!RM.Region__c}</span>
                </div>
                <img src="/resource/TexasCapitalTopLogo" alt="Top Logo" class="header-logo"/>
            </div>
            <!-- Company Description -->
            <div class="section-header">
                <h2>Company Description</h2>
            </div>
            <table class="rc-account-table">
                <tr>
                    <td class="rc-dark-row">Tier</td>
                    <td>
                        <apex:outputField value="{!RM.Tier_Level__c}" />
                    </td>
                    <td class="rc-dark-row">Primary NAICS</td>
                    <td>
                        <apex:inputField value="{!RM.Primary_NAICS__c}" />
                    </td>
                </tr>
                <tr>
                    <td class="rc-dark-row">VIP Client</td>
                    <td>
                        <apex:outputField value="{!RM.Top_Client__c}" />
                    </td>
                    <td class="rc-dark-row">Primary NAICS Description</td>
                    <td>
                        <apex:inputField value="{!RM.Primary_NAICS_Description__c}" />
                    </td>
                </tr>
                <tr>
                    <td class="rc-dark-row">VIP Prospect</td>
                    <td>
                        <apex:outputField value="{!RM.Top_Prospect__c}" />
                    </td>
                    <td class="rc-dark-row">ABL Account</td>
                    <td>
                        <apex:inputField value="{!RM.ABL__c}" />
                    </td>
                </tr>
            </table>

            <table class="rc-account-table">
                <tr>
                    <td class="rc-dark-row">Ownership</td>
                    <td>
                        <apex:inputField value="{!RM.Primary_NAICS_Description__c}" />
                    </td>
                </tr>
                <tr>
                    <td class="rc-dark-row">Business Description</td>
                    <td>
                        <apex:inputField value="{!RM.Business_Description__c}" />
                    </td>
                    <td class="rc-dark-row">Strategic Opportunity</td>
                    <td>
                        <apex:inputField value="{!RM.Primary_NAICS_Description__c}" />
                    </td>
                </tr>
            </table>
            
            <!-- Updated Button Section -->
            <div class="pdfButton" style="float: right">
                <!-- Show Save button only when form is not read-only -->
                <apex:outputPanel rendered="{!!isFormReadOnly}">
                    <apex:commandButton value="Save" action="{!handleSave}"/> 
                </apex:outputPanel>
                
                <!-- Action function for save and open PDF -->
                <apex:actionFunction name="saveAndOpenPDF" action="{!handleSave}" oncomplete="openPDFAfterSave()"/>
                
                <!-- Open PDF button - behavior depends on isFormReadOnly -->
                <!-- When form is editable: Save first then open PDF -->
                <apex:outputPanel rendered="{!!isFormReadOnly}">
                    <button onclick="saveAndOpenPDF(); return false;" type="button">Open PDF</button>
                </apex:outputPanel>
                
                <!-- When form is read-only: Just open PDF without saving -->
                <apex:outputPanel rendered="{!isFormReadOnly}">
                    <button onclick="openPDFDirectly()" type="button">Open PDF</button>
                </apex:outputPanel>
            
            <script>
            // Function called after save completes (when form is editable)
            function openPDFAfterSave() {
                var recId = '{!currentRecordId}';
                var apId = '{!apExist.Id}'; // Account Planning record ID
                var pageName = 'AccountPlanningPDF';
                
                console.log('Opening PDF after save for record: ' + recId);
                
                // Build URL with multiple parameters
                var url = '/apex/' + pageName + '?Id=' + recId + '&apId=' + apId + '&mode=edit';
                window.open(url, '_blank');
            }
            
            // Function called directly when form is read-only
            function openPDFDirectly() {
                var recId = '{!currentRecordId}';
                var apId = '{!apExist.Id}'; // Account Planning record ID
                var pageName = 'AccountPlanningPDF';
                
                console.log('Opening PDF directly for record: ' + recId);
                
                // Build URL with multiple parameters
                var url = '/apex/' + pageName + '?Id=' + recId + '&apId=' + apId + '&mode=readonly';
                window.open(url, '_blank');
            }
            </script>
            </div>
        
        <!-- Footer -->
        <div class="footer">
            <!-- <img class="logo-bottom" src="{!URLFOR($Resource.TexasCapitalBottomLogo)}" /> -->
        </div>
    </body>
    </html>
</apex:form>
</apex:page>
