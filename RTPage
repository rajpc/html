<apex:page standardController="Account" extensions="RelationshipTeamController" docType="html-5.0">
    <apex:slds />
    
    <style>
        .rcrt-team-table { width: 100%; margin: 20px 0; border-collapse: collapse; }
        .rcrt-team-row { display: table-row; }
        .rcrt-team-cell { display: table-cell; width: 50%; padding: 8px; border: 1px solid #ddd; min-height: 2em; }
        .rcrt-role-label { font-weight: bold; }
        .rcrt-role-name { margin-left: 10px; }
        .rcrt-read-only-notice {
            background-color: #fff3cd; border: 1px solid #ffeaa7; color: #856404;
            padding: 12px; margin: 10px 0; border-radius: 4px;
            font-weight: bold; text-align: center;
        }
    </style>

    <div class="slds-scope slds-p-around_medium">
        <apex:form >
            <apex:pageMessages id="messages"/>

            <apex:outputPanel rendered="{!isFormReadOnly}">
                <div class="rcrt-read-only-notice">
                    This form is currently read-only. An Account Planning Period is not active for today's date.
                </div>
            </apex:outputPanel>
        
            <h2>Relationship Team for {!Account.Name}</h2>
            <div class="rcrt-team-table">
                <div class="rcrt-team-row">
                    <div class="rcrt-team-cell">
                        <span class="rcrt-role-label">RM</span>
                        <span class="rcrt-role-name">{!Account.Owner.Name}</span>
                    </div>
                    <div class="rcrt-team-cell">
                        <apex:outputPanel rendered="{!CSO.User.IsActive}">
                            <span class="rcrt-role-label">CSO</span>
                            <span class="rcrt-role-name">{!CSO.User.Name}</span>
                        </apex:outputPanel>
                    </div>
                </div>
                <div class="rcrt-team-row">
                    <div class="rcrt-team-cell">
                        <apex:outputPanel rendered="{!TSO.User.IsActive}">
                            <span class="rcrt-role-label">TSO</span>
                            <span class="rcrt-role-name">{!TSO.User.Name}</span>
                        </apex:outputPanel>
                    </div>
                    <div class="rcrt-team-cell">
                        <apex:outputPanel rendered="{!IBTeamMember.User.IsActive}">
                            <span class="rcrt-role-label">IB</span>
                            <span class="rcrt-role-name">{!IBTeamMember.User.Name}</span>
                        </apex:outputPanel>
                    </div>
                </div>
                <div class="rcrt-team-row">
                    <div class="rcrt-team-cell">
                        <apex:outputPanel rendered="{!TSA.User.IsActive}">
                            <span class="rcrt-role-label">TSA</span>
                            <span class="rcrt-role-name">{!TSA.User.Name}</span>
                        </apex:outputPanel>
                    </div>
                    <div class="rcrt-team-cell">
                        <apex:outputPanel rendered="{!PWA.User.IsActive}">
                            <span class="rcrt-role-label">PWA</span>
                            <span class="rcrt-role-name">{!PWA.User.Name}</span>
                        </apex:outputPanel>
                    </div>
                </div>
            </div>
    
            <div style="float: right; margin-top: 20px;">
                <apex:outputPanel rendered="{!!isFormReadOnly}">
                    <apex:commandButton value="Save" action="{!handleSave}" rerender="messages" styleClass="sds-button slds-button_brand"/> 
                </apex:outputPanel>
                
                <apex:actionFunction name="saveAndOpenPDF" action="{!handleSave}" oncomplete="openPDFAfterSave()" rerender="messages"/>
                
                <apex:outputPanel rendered="{!!isFormReadOnly}">
                    <button onclick="saveAndOpenPDF(); return false;" type="button" class="slds-button slds-button_neutral">Open PDF</button>
                </apex:outputPanel>
                
                <apex:outputPanel rendered="{!isFormReadOnly}">
                    <button onclick="openPDFDirectly()" type="button" class="slds-button slds-button_neutral">Open PDF</button>
                </apex:outputPanel>
            </div>
        </apex:form>
    </div>

    <script>
    function openPDFAfterSave() {
        var recId = '{!Account.Id}';
        var apId = '{!apExist.Id}'; 
        var pageName = 'RelationshipTeamPDF'; 
        
        if (apId) {
            var url = '/apex/' + pageName + '?Id=' + recId + '&apId=' + apId;
            window.open(url, '_blank');
        }
    }
    
    function openPDFDirectly() {
        var recId = '{!Account.Id}';
        var apId = '{!apExist.Id}';
        var pageName = 'RelationshipTeamPDF';
        
        if (apId) {
             var url = '/apex/' + pageName + '?Id=' + recId + '&apId=' + apId;
             window.open(url, '_blank');
        } else {
            alert('No saved record to display in PDF.');
        }
    }
    </script>
</apex:page>
